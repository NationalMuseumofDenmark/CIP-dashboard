<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="vendor/gridster.js/libs/jquery/jquery.js" type="text/javascript"></script>
    <script src="vendor/gridster.js/dist/jquery.gridster.js" type="text/javascript" charset="utf-8"></script>
    <link href="vendor/gridster.js/dist/jquery.gridster.min.css" rel="stylesheet">
    <!-- <script src="vendor/jqplot/jquery.min.js"></script> -->
    <script>
    CIPdashboard = {
      'stats': null,
      'has_become_ready': false,
      'ready': function(handler) {
        if (this.has_become_ready) {
          handler();
        } else {
          $(document).on('CIPdashboard-ready', function() {
            handler();
          });
        }
      },
      'addWidget': function($html_content, sizex, sizey) {
        console.log('CIPdashboard.addWidget()');
        $li = $('<li />');
        $li.append($html_content);
        this.gridster.add_widget($li, sizex, sizey);
        return $li;
      },
      'loadWidgets': function(html_pages) {
        for (var i = 0; i < html_pages.length; i++) {
          var url   = html_pages[i][0];
          var sizex = html_pages[i][1];
          var sizey = html_pages[i][2];
          var $widget = CIPdashboard.addWidget($('<p>Loading...</p>'), sizex, sizey);
          console.log('CIPdashboard: Loading widget: "' + url + '".');
          var success_handler = function($widget) {
            return function(data) {
              console.log('CIPdashboard: Successfully loaded widget: "' + this.url + '".');
              // CIPdashboard.addWidget($(data)), 1, 1);
              $widget.html(''); // Clear "Loading..."
              $widget.append($(data));
            }
          };
          $.get(url).success(success_handler($widget)).error(function() {
            console.log('CIPdashboard: Failed to load widget: "' + this.url + '".');
          });
        }
      }

    };
    $.getJSON('data.json.php').success(function(data) {
        CIPdashboard.stats = data;
        var layout = CIPdashboard.stats['layout']['fields'];

        // convert enums
        for (var i = 0; i < layout.length; i++) {
          var field = layout[i];
          var uuid = field.key;
          if (field.type === 'Enum') {
            // Setup `id` <-> `displaystring` pairing
            var enum_vals = [];
            for (var j = 0; j < field.values.length; j++) {
              enum_vals[field.values[j].id] = field.values[j].displaystring;
            }
            var new_values = {};
            // save old values
            CIPdashboard.stats['stats'][uuid]['enum_values'] = CIPdashboard.stats['stats'][uuid]['values'];
            for (var id in CIPdashboard.stats['stats'][uuid]['values']) {
              var value_count = CIPdashboard.stats['stats'][uuid]['values'][id];
              new_values[enum_vals[id]] = value_count;
            }
            CIPdashboard.stats['stats'][uuid]['values'] = new_values;
          }
        }
      $(document).on('CIPdashboard-ready', function() {
        CIPdashboard.has_become_ready = true;
      });

      $(document).ready(function(){ //DOM Ready
        CIPdashboard.gridster = $(".gridster > ul").gridster({
          widget_margins: [10, 10],
          widget_base_dimensions: [250, 250],
          // min_cols: 6,
          // gridster.js does NOT work with elements other than <li>
          // widget_selector: 'div', 
          resize: {
            enabled: true
          }
        }).data('gridster');
        $(document).trigger('CIPdashboard-ready');
        CIPdashboard.loadWidgets([
          // [file_url, sizex, sizey],
            ['widgets/published/published.html',             1 , 1 ]
          //['widgets/piechart/piechart.html',               1 , 1 ],
          , ['widgets/percentage/percentage.html',           2 , 1 ]
          , ['widgets/field_inspector/field_inspector.html', 3 , 1 ]
          // , ['widgets/CIPlayout/CIPlayout.html',             3 , 2 ]
        ]);
      });
    }).error(function(data) {
      console.log('CIPdashboard: data.json.php returned: "' + data.responseText + '".');
      $('.gridster').text(data.responseText);
      $('.gridster').css('background-color', 'white');
      $('.gridster').css('color', 'red');
    });
    </script>
  </head>
  <body>
    <div id="main-column" class="col-md-offset-2 col-md-8">
      <h1>CIP dashboard</h1>
      <div class="gridster">
        <ul>
        </ul>
      </div>
    </div>
  </body>
</html>
