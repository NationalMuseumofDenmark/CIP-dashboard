<!-- TODO: Loading these two script breaks the piechart-widget -->
<!-- <script src="vendor/jqplot/jquery.min.js"></script> -->
<script>
requirejs(['jquery', 'jqplot',  'jqplot.barRenderer', 'jqplot.categoryAxisRenderer',
  'jqplot.pointLabels',
  'jqplot.dateAxisRenderer',
  'jqplot.canvasTextRenderer',
  'jqplot.canvasAxisTickRenderer'
], function($) {

  var options = {
    // The "seriesDefaults" option is an options object that will
    // be applied to all series in the chart.
    seriesDefaults:{
      renderer:$.jqplot.BarRenderer,
      rendererOptions: {fillToZero: true}
    },
    // Custom labels for the series are specified with the "label"
    // option on the series option.  Here a series option object
    // is specified for each series.
    //// series:[
    ////     {label:'Hotel'},
    ////     {label:'Event Regristration'},
    ////     {label:'Airfare'}
    //// ],
    // Show the legend and put it outside the grid, but inside the
    // plot container, shrinking the grid to accomodate the legend.
    // A value of "outside" would not shrink the grid and allow
    // the legend to overflow the container.
    legend: {
      show: false
      // placement: 'outsideGrid'
    },
    axes: {
      // Use a category axis on the x axis and use our custom ticks.
      xaxis: {
        renderer: $.jqplot.CategoryAxisRenderer,
        tickRenderer: $.jqplot.CanvasAxisTickRenderer,
        ticks: [],
        tickOptions: {
          angle: -30,
          fontSize: '10pt'
        }
      },
      // Pad the y axis just a little so bars can get close to, but
      // not touch, the grid boundaries.  1.2 is the default padding.
      yaxis: {
        // label: 'Count',
        min: 0,
        pad: 1.05
        //tickOptions: {formatString: '$%d'}
      }
    }
  }

  var select_change_handler = function() {
    var $optionSelected = $("#field-inspector-select option:selected");
    //var $optionSelected = $($("option:selected", this));
    var field = $optionSelected.data('field');
    var uuid = field.key;

    var values = [];
    var counts = [];
    var stats = CIPdashboard.stats['stats'];
    for (var value in stats[uuid]['values']) {
      var count = stats[uuid]['values'][value];
      counts.push(count);
      if (parseInt(value) !== NaN) {
        values.push(parseInt(value));
      } else {
        values.push(value);
      }
    }
    console.log(counts);
    console.log(values);

    // Make histogram
    if (stats[uuid]['type'] == "length" && values.length > 35) {
      var bin_count = 15;
      var new_ticks = [];
      var new_counts = [];

      var min = Math.min.apply(null, values);
      var max = Math.max.apply(null, values);
      var step = Math.round((max - min) / bin_count);
      for (var i = 0; i < bin_count + 1; i++) {
        new_ticks.push(min + i * step);
        new_counts.push(0);
      }
      console.log(new_ticks);
      console.log(new_counts);

      values.sort();
      var i = 0;
      for (value in values) {
        if (stats[uuid]['values'][value] < new_ticks[i+1]) {
          new_counts[i] += stats[uuid]['values'][value];
        } else {
          i++;
        }
      }

      values = new_ticks;
      counts = new_counts;
    }

    // Add empty values to histogram
    if ($('#field-inspector-showempty input').is(':checked')) {
      counts.push(stats[uuid]['empty_values']);
      values.push('(tomt felt)');
    }

    // plot1.series[0].data = counts;
    // plot1.axes.xaxis.ticks = values;
    // plot1.replot({resetAxes: true, data:[counts], axes:{xaxis:{ticks:values}}});

    // Alternative replot
    $('div#chart-field-inspector').html('');
    if (values.length > 0) {
      options.title = stats[uuid]['name'];
      options.axes.xaxis.label = stats[uuid]['type'];

      options.axes.xaxis.ticks = values;
      var plot1 = $.jqplot('chart-field-inspector', [counts], options);
    }
  };

  $('#field-inspector-select').change(select_change_handler);
  $('#field-inspector-showempty input').change(select_change_handler);

  // Ensure that a field is selected from the beginning
  select_change_handler.apply($('#field-inspector-select'));
});
</script>
<script>
  var getPercentage = function(percentage) {
    return (percentage * 100).toFixed(1) + '%';
  }
  var getFilledPercentage = function(uuid) {
    var stats_field = CIPdashboard.stats['stats'][uuid];
    console.log(stats_field['empty_values']);
    var empty_percentage = (stats_field['zero_length_values'] + stats_field['empty_values']) / CIPdashboard.stats['total_count'];
    var filled_percentage = 1.0 - empty_percentage;
    return getPercentage(filled_percentage);
  }

  // Sort field list alphabetically.
  var layout = $(CIPdashboard.stats['layout']['fields']).sort(function(a, b) {
    var aname = a['name'].toUpperCase();
    var bname = b['name'].toUpperCase();
    if (aname > bname) {
      return 1;
    } else if (aname < bname) {
      return -1;
    }
    return 0;
  });

  // Add fields to <select>
  for (var i = 0; i < layout.length; i++) {
    var $option = $('<option>' + layout[i]['name'] + '</option>');
    $option.data('field', layout[i]);
    $('#field-inspector-select').append($option);
  }
  $('#field-inspector-select').change(function() {
    var $optionSelected = $($("option:selected", this));
    var field = $optionSelected.data('field');
    console.log(field);
    $('#field-inspector-uuid').text(field.key);
    $('#field-inspector-percentage').text(getFilledPercentage(field.key));
  });
</script>

<h1>Field inspector</h1>
<select id="field-inspector-select"></select>
<label id="field-inspector-showempty"><input type="checkbox">Show empty</label>
<div id="chart-field-inspector" style="width:700px; height:225px;"></div>
<style>
#field-inspector-select {
  float: right;
}
#field-inspector-showempty {
  float: right;
  clear: both;
}
</style>
